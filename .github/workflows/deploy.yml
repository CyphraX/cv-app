name: Deploy to K3s

on:
  workflow_run:
    workflows: ["Backend CI/CD", "Frontend CI/CD"]
    types: [completed]
    branches: [master]
  workflow_dispatch:
    inputs:
      component:
        description: "Component to deploy"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - backend
          - frontend

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine what to deploy
        id: deploy-target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "target=${{ github.event.inputs.component }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.name }}" == "Backend CI/CD" ]; then
            echo "target=backend" >> $GITHUB_OUTPUT
          else
            echo "target=frontend" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Backend
        if: steps.deploy-target.outputs.target == 'backend' || steps.deploy-target.outputs.target == 'all'
        run: |
          kubectl rollout restart deployment/cv-backend -n cv-app
          kubectl rollout status deployment/cv-backend -n cv-app --timeout=180s
          echo "###  Backend Deployed" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Frontend
        if: steps.deploy-target.outputs.target == 'frontend' || steps.deploy-target.outputs.target == 'all'
        run: |
          kubectl rollout restart deployment/cv-frontend -n cv-app
          kubectl rollout status deployment/cv-frontend -n cv-app --timeout=120s
          echo "###  Frontend Deployed" >> $GITHUB_STEP_SUMMARY

      - name: Verify Deployment
        run: |
          echo "###  Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n cv-app >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
